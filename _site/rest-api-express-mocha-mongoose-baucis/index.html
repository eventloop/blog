<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="Responsive Bootstrap App Landing Page Template">
  <meta name="keywords" content="Kane, Bootstrap, Landing page, Template, App, Mobile, Android, iOS">
  <meta name="author" content="Mizanur Rahman">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>REST API en Express usando Mocha, Mongoose y Baucis</title>

  <link rel="icon" href="/images/favicon.png">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

  <link href='http://fonts.googleapis.com/css?family=Roboto:100,300,100italic,400,300italic' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/stylesheets/styles.css">
  <link rel="stylesheet" href="/stylesheets/colors/yellow.css">

  <link rel="stylesheet" href="/stylesheets/responsive.css">
  <link rel="stylesheet" href="/stylesheets/pygment_trac.css">
</head>
<body>
  <div class="navbar navbar-inverse bs-docs-nav navbar-fixed-top sticky-navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#kane-navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/"><img src="/images/js-logo.png" alt=""></a>
      </div>
      <div class="navbar-collapse collapse" id="kane-navigation">
        <ul class="nav navbar-nav navbar-right main-navigation">
          <li><a href="/">Home</a></li>
          <li><a href="/#services">Eventos</a></li>
          <li><a href="/blog">Artículos</a></li>
          <li><a href="#newsletters">Newsletters</a></li>
          <li><a href="/#contact">Contáctanos</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="app-brief blog">
    <div class="container">
      <div class="col-md-8 col-md-push-2 left-align">
        <div class="post fadeInLeft animated">
          <h1 class="post-title">REST API en Express usando Mocha, Mongoose y Baucis</h1>
          <div class="post-content">
            <p>Crearemos una REST API en Express con MongoDB, para ello vamos a utilizar Mongoose y Baucis. Usaremos Mocha para hacer pruebas unitarias y tener más claridad de lo que queremos obtener. Los archivos que creamos son los siguientes:</p>

<p><code>
.
  ├─ node_modules
  ├─ package.json
  ├─ server
  │  ├─ lib
  │     └─ mongoose.js
  │  └─ models
  │     └─ todo.js
  ├─ server.js
  └─ test
     └─ api.js
</code></p>

<h2 id="instalando-dependencias">Instalando dependencias</h2>

<p>Estas son las dependencias que instalaremos:</p>

<ul>
  <li>mocha</li>
  <li>supertest</li>
  <li>express</li>
  <li>body-parser</li>
  <li>mongoose</li>
  <li>baucis</li>
</ul>

<p>Instalaremos la librería <code>mocha</code> a nivel global para poder ejecutarla en la línea de comandos. Con <code>supertest</code> haremos solicitudes HTTP y junto con <code>mocha</code> realizaremos pruebas unitarias de nuestra API. Con <code>express</code> podremos crear un server y administrar rutas. Con <code>body-parser</code>, que es un middleware para <code>express</code>, permitiremos el envío de datos a través de POST y PUT. Con <code>mongoose</code> crearemos nuestros esquemas de modelos para MongoDB y con <code>baucis</code> crearemos fácilmente una API con los métodos que necesitemos: HEAD, POST, GET, PUT, DELETE.</p>

<p>Primero, es necesario iniciar un proyecto previamente con <em>npm init</em> o crear manualmente el archivo <code>package.json</code> con datos como los siguientes:</p>

<p><code>
{
  "name": "rest-api-express",
  "main": "server.js"
}
</code></p>

<p>Después debemos instalar las dependencias que necesitamos.</p>

<p><code>bash
$ npm install -g mocha
$ npm install --save-dev supertest
$ npm install --save express body-parser mongoose baucis
</code></p>

<p>No olvides añadir los argumentos. <code>-g</code> instalará una librería a nivel global, <code>--save</code> y <code>--save-dev</code> guardará las dependencias en modo producción y desarrollo, respectivamente, dentro de <code>package.json</code>.</p>

<h2 id="probando-el-funcionamiento-de-la-api">Probando el funcionamiento de la API</h2>

<p>Estas son las rutas que queremos de nuestra API, con los métodos que necesitamos:</p>

<p><code>
GET     /api/todos          Obtiene todas las tareas
POST    /api/todos          Crea una tarea
GET     /api/todos/:id      Obtiene una tarea
PUT     /api/todos/:id      Actualiza una tarea
DELETE  /api/todos/:id      Elimina una tarea
</code></p>

<p>Primero haremos pruebas unitarias de nuestros esquemas de <code>mongoose</code>, comprobando si tienen las propiedades que queremos y si están declaradas correctamente; podemos verificar si están definidas, el tipo (<em>String</em>, <em>Object</em>, <em>Date</em>, <em>Boolean</em>), si es requerida, si tiene un valor por defecto, si tiene índices, etcétera.</p>

<p>```js
var assert   = require(‘assert’),
    mongoose = require(‘mongoose’),
    Todo     = require(‘../server/models/todo’);</p>

<p>describe(‘modelo <code>Todo</code>’, function () {
  before(function () {
    this.schema = Todo.schema.paths;
  });</p>

<p>it(‘debe tener la propiedad <code>title</code> correctamente’, function () {
    // La propiedad <code>title</code> debe ser diferente de “undefined”
    assert.notEqual(this.schema.title, undefined);
    // La propiedad <code>title</code> debe ser del tipo String
    assert.equal(this.schema.title.options.type, String);
    // La propiedad <code>title</code> es requerida
    assert.equal(this.schema.title.options.required, true);
  });</p>

<p>it(‘debe tener la propiedad <code>author</code> correctamente’, function () {
    // La propiedad <code>author</code> debe ser diferente de “undefined”
    assert.notEqual(this.schema.author, undefined);
    // La propiedad <code>author</code> debe ser del tipo ObjectId
    assert.equal(this.schema.author.options.type, mongoose.Schema.ObjectId);
    // La propiedad <code>author</code> debe tener Author como referencia de modelo
    assert.equal(this.schema.author.options.ref, ‘Author’);
  });</p>

<p>it(‘debe tener la propiedad <code>completed</code> correctamente’, function () {
    // La propiedad <code>completed</code> debe ser diferente de “undefined”
    assert.notEqual(this.schema.completed, undefined);
    // La propiedad <code>completed</code> debe ser del tipo Boolean
    assert.equal(this.schema.completed.options.type, Boolean);
    // La propiedad <code>completed</code> debe ser “false” por defecto
    assert.equal(this.schema.completed.options.default, false);
  });</p>

<p>it(‘debe tener la propiedad <code>created_at</code> correctamente’, function () {
    // La propiedad <code>created_at</code> debe ser diferente de “undefined”
    assert.notEqual(this.schema.created_at, undefined);
    // La propiedad <code>created_at</code> debe ser del tipo Date
    assert.equal(this.schema.created_at.options.type, Date);
  });
});
```</p>

<p>Después necesitamos añadir las pruebas de solicitudes HTTP con <code>supertest</code>, esto asegurará el funcionamiento de la API y evitaremos hacer pruebas con <code>curl</code> o <code>postman</code>.</p>

<p>```js
var assert   = require(‘assert’),
    mongoose = require(‘mongoose’),
    request  = require(‘supertest’),
    server   = require(‘../server’),
    Todo     = require(‘../server/models/todo’);</p>

<p>// Definimos agente, lo único que necesitamos es pasar como argumento
// el server de express que será exportado en server.js
var user = request(server);</p>

<p>describe(‘/api/todos’, function (done) {
  // Todo de prueba
  var todo = {
    title: ‘Foobar’,
    author: ‘Jeduan Cornejo’
  };</p>

<p>it(‘usuario debe poder crear una tarea’, function (done) {
    user
      .post(‘/api/todos’)
      .send({
        title: todo.title,
        author: todo.author
      })
      .expect(201, function (err, res) {
        if (err) done(err);</p>

<pre><code>    // Guardamos la _id en el objeto
    todo.id = res.body._id;

    done();
  });   });
</code></pre>

<p>it(‘usuario debe poder obtener una tarea’, function (done) {
    user
      .get(‘/api/todos/’ + todo.id)
      .expect(200, function (err, res) {
        if (err) done(err);</p>

<pre><code>    // Comprobamos que el título coincida con el devuelto por el servidor
    assert.equal(res.body.title, todo.title);
    // Comprobamos que el autor coincida con el devuelto por el servidor
    assert.equal(res.body.author, todo.author);
    // Comprobamos que completed se encuentre en false
    assert.equal(res.body.completed, false);

    done();
  });   });
</code></pre>

<p>it(‘usuario debe poder actualizar una tarea’, function (done) {
    user
      .put(‘/api/todos/’ + todo.id)
      .send({ completed: true })
      .expect(200, function (err, res) {
        if (err) done(err);</p>

<pre><code>    // Comprobamos que completed haya cambiado a true
    assert.equal(res.body.completed, true);

    done();
  });   });
</code></pre>

<p>it(‘usuario debe poder eliminar una tarea’, function (done) {
    user
      .delete(‘/api/todos/’ + todo.id)
      .expect(200, done);
  });
});
```</p>

<p>Ahora necesitas correr las pruebas con <code>$ mocha api/test</code>. Una vez que tengamos bien definidas las pruebas, nos daremos cuenta que poco importa si usamos <code>baucis</code> o cualquier otra librería, siempre y cuando las pruebas se cumplan. Se pueden añadir pruebas para verificar si el usuario tiene o no permiso de administrar tareas, probar si una propiedad refiere a otro modelo con <a href="http://mongoosejs.com/docs/populate.html">population</a>, etcétera.</p>

<h2 id="creando-servidor-con-express">Creando servidor con Express</h2>

<p>```js
// Llamamos las dependencias que necesitamos
var express    = require(‘express’),
    bodyParser = require(‘body-parser’),
    baucis     = require(‘baucis’),
    Todo       = require(‘./server/models/todo’);</p>

<p>// Creamos un nuevo servidor
var server = express();</p>

<p>// Incluimos la configuración de bodyParser
server.use(bodyParser.urlencoded({ extended: true }));
server.use(bodyParser.json());</p>

<p>// Controlador
var todoController = baucis.rest(‘Todo’);</p>

<p>// Si deseas restringir rutas, puedes hacerlo con middlewares, v.g.:
// todoController.request(‘post put delete’, function (req, res, next) {
//   if (req.isAuthenticated()) return next();
//   return res.send(401);
// });</p>

<p>// Incluimos plugin de baucis a Express con raíz /api
server.use(‘/api’, baucis());</p>

<p>// Iniciamos el servidor en puerto 3000, si no existe la variable de entorno
server.listen(process.env.PORT || 3000);</p>

<p>// Esta línea es muy importante para hacer funcionar Mocha y Supertest
module.exports = server;
```</p>

<p>Con lo anterior crearemos una API rápidamente con pruebas unitarias. De las ventajas que tenemos al usar <a href="http://kun.io/baucis">Baucis</a> es que podemos controlar y escalar fácilmente nuestra API, podemos añadir <em>middlewares</em>, hacer <em>streaming</em> para grandes cantidades de información, administrar versiones, extraer datos con solicitudes dinámicas con <em>query options</em>, entre otras.</p>

<p>Puedes ver este ejemplo en <a href="https://github.com/markotom/javascriptmx/tree/master/rest-api-mocha-mongoose-baucis/example">Github</a>.</p>

          </div>

          <div class="meta">
            <div class="author clearfix">
              <a href="http://github.com/markotom" class="author-avatar pull-left">
                
                  <img src="http://gravatar.com/avatar/340cf435956320a68d9d1e6a82ba13c3" class="img-circle" alt="">
                
              </a>
              
              <div class="author-info">
                <div class="author-name"><strong>Marco Godínez</strong></div>
                <div class="author-description text-muted">Frontend Web Developer</div>
                <a href="http://github.com/markotom">http://github.com/markotom</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="container">
      <ul class="social-icons">
        <li><a href="//facebook.com/javascriptmx">
          <?xml version="1.0" encoding="utf-8"?> <!-- Generator: IcoMoon.io --> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"> <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000"><g><path d="M 26,0L 6,0 C 2.686,0,0,2.686,0,6l0,20 c0,3.314, 2.686,6, 6,6l 20,0 c 3.314,0, 6-2.686, 6-6L 32,6 C 32,2.686, 29.314,0, 26,0z M 20.136,15.998L 17.514,16l-0.002,9.6L 13.914,25.6 L 13.914,16 l-2.4,0 L 11.514,12.692 l 2.4-0.002L 13.91,10.742C 13.91,8.042, 14.642,6.4, 17.82,6.4l 2.648,0 l0,3.31 L 18.812,9.71 c-1.238,0-1.298,0.462-1.298,1.324L 17.51,12.69l 2.976,0 L 20.136,15.998z"></path></g></svg>
        </a></li>
        <li><a href="//twitter.com/javascriptmx">
          <?xml version="1.0" encoding="utf-8"?> <!-- Generator: IcoMoon.io --> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"> <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000"><g><path d="M 26,0L 6,0 C 2.686,0,0,2.686,0,6l0,20 c0,3.314, 2.686,6, 6,6l 20,0 c 3.314,0, 6-2.686, 6-6L 32,6 C 32,2.686, 29.314,0, 26,0z M 23.96,12.408c 0.008,0.17, 0.012,0.34, 0.012,0.51c0,5.206-3.962,11.208-11.208,11.208c-2.224,0-4.294-0.652-6.038-1.77 c 0.308,0.036, 0.622,0.056, 0.94,0.056c 1.846,0, 3.544-0.63, 4.892-1.686c-1.724-0.032-3.178-1.172-3.68-2.736 C 9.12,18.036, 9.364,18.060, 9.62,18.060c 0.36,0, 0.708-0.048, 1.038-0.138C 8.856,17.56, 7.498,15.968, 7.498,14.060c0-0.016,0-0.032,0-0.050 c 0.532,0.296, 1.138,0.472, 1.784,0.494C 8.226,13.798, 7.53,12.592, 7.53,11.226c0-0.722, 0.194-1.398, 0.532-1.98 c 1.942,2.384, 4.846,3.952, 8.12,4.116C 16.114,13.074, 16.080,12.772, 16.080,12.464c0-2.174, 1.764-3.938, 3.94-3.938 c 1.132,0, 2.156,0.478, 2.876,1.244c 0.898-0.178, 1.742-0.506, 2.502-0.956c-0.294,0.92-0.918,1.692-1.732,2.18 c 0.796-0.094, 1.556-0.308, 2.262-0.62C 25.4,11.162, 24.73,11.856, 23.96,12.408z"></path></g></svg>
        </a></li>
      </ul>
      <p class="copyright">
        ©2015 JavascriptMX, todos los derechos reservados.
      </p>

    </div>
  </footer> 

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53721608-1', 'auto');
    ga('send', 'pageview');
  </script>

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

</body>
</html>
